

















Timestep:  96%|████████████████████████████████████████████████████████████████████████████████████████▎   | 48/50 [00:33<00:01,  1.45it/s]

















Timestep:  96%|████████████████████████████████████████████████████████████████████████████████████████▎   | 48/50 [00:33<00:01,  1.43it/s]

















Timestep:  96%|████████████████████████████████████████████████████████████████████████████████████████▎   | 48/50 [00:33<00:01,  1.42it/s]

















Timestep:  94%|██████████████████████████████████████████████████████████████████████████████████████▍     | 47/50 [00:33<00:02,  1.42it/s]
images tensor([[[[0.6494, 0.7178, 0.6855,  ..., 0.8892, 0.8896, 0.9043],
          [0.6646, 0.6548, 0.6719,  ..., 0.8867, 0.8911, 0.9106],
          [0.6836, 0.6738, 0.6821,  ..., 0.9004, 0.8813, 0.8955],
          ...,
          [0.7607, 0.7100, 0.6685,  ..., 0.4551, 0.4031, 0.4351],
          [0.7212, 0.7168, 0.7188,  ..., 0.4500, 0.4602, 0.4309],
          [0.6904, 0.7339, 0.7520,  ..., 0.4001, 0.4346, 0.3940]],
         [[0.6455, 0.7017, 0.6738,  ..., 0.8853, 0.8955, 0.9092],
          [0.6514, 0.6479, 0.6709,  ..., 0.8882, 0.8911, 0.9062],
          [0.6782, 0.6699, 0.6768,  ..., 0.8989, 0.8857, 0.8921],
          ...,
          [0.7642, 0.7129, 0.6602,  ..., 0.4475, 0.3901, 0.4199],
          [0.7251, 0.7290, 0.7197,  ..., 0.4446, 0.4653, 0.4321],
          [0.6660, 0.7378, 0.7554,  ..., 0.4041, 0.4380, 0.3801]],
         [[0.6396, 0.6992, 0.6831,  ..., 0.8774, 0.8965, 0.8853],
          [0.6572, 0.6543, 0.6680,  ..., 0.8916, 0.8994, 0.9082],
          [0.6816, 0.6709, 0.6758,  ..., 0.8994, 0.8857, 0.8994],
          ...,
          [0.7578, 0.7183, 0.6621,  ..., 0.4534, 0.4050, 0.4268],
          [0.7236, 0.7246, 0.7251,  ..., 0.4478, 0.4717, 0.4250],
          [0.6719, 0.7432, 0.7617,  ..., 0.4153, 0.4365, 0.3840]]],
        [[[0.9912, 0.9502, 0.9536,  ..., 0.9248, 0.5649, 0.3711],
          [0.9873, 0.9717, 0.9751,  ..., 0.9204, 0.4678, 0.2666],
          [0.9912, 0.9824, 0.9839,  ..., 0.9336, 0.4246, 0.2239],
          ...,
          [0.7100, 0.7100, 0.7085,  ..., 0.7109, 0.6914, 0.5659],
          [0.7104, 0.7061, 0.7070,  ..., 0.7109, 0.6792, 0.4983],
          [0.6777, 0.7075, 0.7119,  ..., 0.5352, 0.5518, 0.6987]],
         [[0.9746, 0.9629, 0.9531,  ..., 0.8975, 0.4946, 0.2935],
          [1.0000, 0.9736, 0.9795,  ..., 0.8926, 0.4214, 0.2007],
          [0.9951, 0.9951, 0.9922,  ..., 0.8862, 0.4150, 0.2024],
          ...,
          [0.2773, 0.2842, 0.2764,  ..., 0.7061, 0.6665, 0.5332],
          [0.2725, 0.2725, 0.2715,  ..., 0.6582, 0.6768, 0.5054],
          [0.3052, 0.2778, 0.2705,  ..., 0.4792, 0.5229, 0.6685]],
         [[0.9150, 0.9263, 0.9224,  ..., 0.7798, 0.3872, 0.2324],
          [0.9727, 0.9575, 0.9546,  ..., 0.7856, 0.3330, 0.1572],
          [0.9946, 0.9907, 0.9824,  ..., 0.7954, 0.3357, 0.1746],
          ...,
          [0.1667, 0.1841, 0.1799,  ..., 0.6069, 0.5659, 0.4321],
          [0.1782, 0.1775, 0.1719,  ..., 0.5830, 0.5557, 0.3733],
          [0.2175, 0.1855, 0.1809,  ..., 0.3877, 0.4004, 0.5200]]],
        [[[0.9746, 0.9565, 0.9556,  ..., 0.0720, 0.0718, 0.0820],
          [0.9556, 0.9458, 0.9438,  ..., 0.0637, 0.0732, 0.0786],
          [0.9551, 0.9473, 0.9507,  ..., 0.0635, 0.0632, 0.0720],
          ...,
          [0.0984, 0.0891, 0.0840,  ..., 0.3633, 0.3906, 0.4324],
          [0.1077, 0.0942, 0.0886,  ..., 0.3689, 0.3823, 0.4502],
          [0.1006, 0.0750, 0.0635,  ..., 0.3579, 0.3711, 0.4453]],
         [[0.9551, 0.9580, 0.9551,  ..., 0.2183, 0.1760, 0.1492],
          [0.9756, 0.9678, 0.9653,  ..., 0.1768, 0.1694, 0.1287],
          [0.9521, 0.9639, 0.9570,  ..., 0.1650, 0.1445, 0.1465],
          ...,
          [0.1692, 0.1541, 0.1562,  ..., 0.3015, 0.3379, 0.3762],
          [0.1702, 0.1624, 0.1609,  ..., 0.2971, 0.3257, 0.3960],
          [0.1523, 0.1499, 0.1477,  ..., 0.2976, 0.3179, 0.3862]],
         [[0.9766, 0.9727, 0.9834,  ..., 0.2524, 0.1841, 0.1426],
          [1.0000, 0.9834, 0.9902,  ..., 0.1970, 0.1606, 0.1060],
          [0.9971, 0.9844, 0.9810,  ..., 0.1758, 0.1292, 0.1072],
          ...,
          [0.2537, 0.2529, 0.2415,  ..., 0.2842, 0.3110, 0.3425],
          [0.2527, 0.2515, 0.2598,  ..., 0.2839, 0.2996, 0.3501],
          [0.2212, 0.2390, 0.2358,  ..., 0.2878, 0.2969, 0.3408]]],
        ...,
        [[[0.7827, 0.7886, 0.7803,  ..., 0.7759, 0.7729, 0.7822],
          [0.7827, 0.7837, 0.7852,  ..., 0.7764, 0.7754, 0.7842],
          [0.7822, 0.7803, 0.7793,  ..., 0.7788, 0.7744, 0.7871],
          ...,
          [0.6392, 0.6362, 0.6533,  ..., 0.2407, 0.2310, 0.2539],
          [0.6387, 0.6348, 0.6514,  ..., 0.2427, 0.2285, 0.2446],
          [0.6465, 0.6323, 0.6494,  ..., 0.2368, 0.2231, 0.2292]],
         [[0.8345, 0.8296, 0.8320,  ..., 0.7910, 0.7910, 0.7944],
          [0.8330, 0.8315, 0.8340,  ..., 0.7954, 0.7871, 0.7852],
          [0.8345, 0.8359, 0.8340,  ..., 0.7925, 0.7939, 0.7959],
          ...,
          [0.6860, 0.6709, 0.6943,  ..., 0.1389, 0.1228, 0.1331],
          [0.6899, 0.6729, 0.6865,  ..., 0.1270, 0.1282, 0.1372],
          [0.6738, 0.6719, 0.6919,  ..., 0.1199, 0.1130, 0.1133]],
         [[0.8672, 0.8721, 0.8794,  ..., 0.8120, 0.8252, 0.8096],
          [0.8750, 0.8867, 0.8809,  ..., 0.8198, 0.8232, 0.8301],
          [0.8896, 0.8872, 0.8774,  ..., 0.8169, 0.8140, 0.8267],
          ...,
          [0.7363, 0.7358, 0.7559,  ..., 0.1216, 0.1135, 0.1204],
          [0.7354, 0.7305, 0.7471,  ..., 0.1130, 0.1162, 0.1116],
          [0.7163, 0.7285, 0.7490,  ..., 0.1133, 0.1057, 0.1006]]],
        [[[0.2781, 0.2642, 0.2612,  ..., 0.2666, 0.2400, 0.2231],
          [0.2803, 0.2686, 0.2700,  ..., 0.2749, 0.2297, 0.2144],
          [0.2700, 0.2629, 0.2637,  ..., 0.2837, 0.2385, 0.2029],
          ...,
          [0.8252, 0.8203, 0.8242,  ..., 0.8315, 0.8408, 0.8457],
          [0.8203, 0.8223, 0.8262,  ..., 0.8315, 0.8398, 0.8413],
          [0.8159, 0.8320, 0.8281,  ..., 0.8296, 0.8457, 0.8354]],
         [[0.3064, 0.2959, 0.2954,  ..., 0.2529, 0.2180, 0.2004],
          [0.3103, 0.3022, 0.3066,  ..., 0.2578, 0.2156, 0.1904],
          [0.3042, 0.2900, 0.3027,  ..., 0.2603, 0.2258, 0.1926],
          ...,
          [0.8291, 0.8242, 0.8276,  ..., 0.8364, 0.8340, 0.8418],
          [0.8330, 0.8193, 0.8174,  ..., 0.8340, 0.8379, 0.8394],
          [0.8213, 0.8418, 0.8350,  ..., 0.8467, 0.8584, 0.8477]],
         [[0.2239, 0.2080, 0.1990,  ..., 0.2192, 0.1943, 0.1777],
          [0.2173, 0.2046, 0.2124,  ..., 0.2295, 0.1929, 0.1665],
          [0.2163, 0.1992, 0.2090,  ..., 0.2424, 0.2117, 0.1680],
          ...,
          [0.8418, 0.8398, 0.8350,  ..., 0.8438, 0.8501, 0.8535],
          [0.8418, 0.8296, 0.8384,  ..., 0.8447, 0.8477, 0.8623],
          [0.8340, 0.8516, 0.8398,  ..., 0.8496, 0.8506, 0.8281]]],
        [[[0.9600, 0.9521, 0.9512,  ..., 0.9146, 0.9072, 0.9146],
          [0.9561, 0.9521, 0.9580,  ..., 0.9155, 0.9180, 0.9243],
          [0.9507, 0.9360, 0.9434,  ..., 0.9170, 0.9136, 0.9209],
          ...,
          [0.5239, 0.5947, 0.6240,  ..., 0.0737, 0.0889, 0.1084],
          [0.8574, 0.8740, 0.8750,  ..., 0.0771, 0.0781, 0.1047],
          [0.8730, 0.8843, 0.8911,  ..., 0.0828, 0.0850, 0.1252]],
         [[0.9478, 0.9424, 0.9443,  ..., 0.9199, 0.9185, 0.9189],
          [0.9507, 0.9482, 0.9531,  ..., 0.9219, 0.9170, 0.9233],
          [0.9448, 0.9355, 0.9448,  ..., 0.9219, 0.9248, 0.9209],
          ...,
          [0.5146, 0.5718, 0.5791,  ..., 0.0469, 0.0598, 0.0574],
          [0.8447, 0.8672, 0.8398,  ..., 0.0366, 0.0605, 0.0591],
          [0.8623, 0.8818, 0.8740,  ..., 0.0332, 0.0574, 0.0564]],
         [[0.8975, 0.9102, 0.9248,  ..., 0.9082, 0.9141, 0.8945],
          [0.9238, 0.9307, 0.9375,  ..., 0.9180, 0.9180, 0.9238],
          [0.9336, 0.9248, 0.9224,  ..., 0.9170, 0.9111, 0.9199],
          ...,
          [0.4365, 0.5400, 0.5425,  ..., 0.0330, 0.0356, 0.0405],
          [0.7500, 0.8110, 0.8027,  ..., 0.0208, 0.0347, 0.0339],
          [0.7812, 0.8281, 0.8135,  ..., 0.0254, 0.0398, 0.0417]]]],
       device='cuda:0', dtype=torch.float16)
                                                                                                                                           Traceback (most recent call last):
  File "/home/czr/anaconda3/envs/MM/lib/python3.8/site-packages/PIL/Image.py", line 3281, in open
    fp.seek(0)
AttributeError: 'Tensor' object has no attribute 'seek'
During handling of the above exception, another exception occurred:
Traceback (most recent call last):
  File "experimental/ddpo_finetune.py", line 140, in <module>
    trainer.train()
  File "/home/czr/anaconda3/envs/MM/lib/python3.8/site-packages/trl/trainer/ddpo_trainer.py", line 604, in train
    global_step = self.step(epoch, global_step)
  File "/home/czr/anaconda3/envs/MM/lib/python3.8/site-packages/trl/trainer/ddpo_trainer.py", line 258, in step
    rewards, rewards_metadata = self.compute_rewards(
  File "/home/czr/anaconda3/envs/MM/lib/python3.8/site-packages/trl/trainer/ddpo_trainer.py", line 218, in compute_rewards
    reward, reward_metadata = self.reward_fn(images, prompts, prompt_metadata)
  File "experimental/ddpo_finetune.py", line 84, in wrapper_reward_fn
    score = reward_model.get_score([image], prompt)
  File "/home/czr/MM-Reward/./reward_models/score_reward_models.py", line 85, in get_clipscore
    images = [self.open_image(image) for image in images_path]
  File "/home/czr/MM-Reward/./reward_models/score_reward_models.py", line 85, in <listcomp>
    images = [self.open_image(image) for image in images_path]
  File "/home/czr/MM-Reward/./reward_models/score_reward_models.py", line 65, in open_image
    image = Image.open(image)
  File "/home/czr/anaconda3/envs/MM/lib/python3.8/site-packages/PIL/Image.py", line 3283, in open
    fp = io.BytesIO(fp.read())
AttributeError: 'Tensor' object has no attribute 'read'